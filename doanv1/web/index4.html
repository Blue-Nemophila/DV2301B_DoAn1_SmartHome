<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Home Control - 5 Thiết Bị</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary: #2563eb;
        --secondary: #7c3aed;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --dark: #0f172a;
        --card: #1e293b;
        --text: #f1f5f9;
        --text-light: #94a3b8;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    body {
        background: var(--dark);
        color: var(--text);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Header */
    .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 25px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
    }
    
    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    
    .header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
    }
    
    /* Main Layout */
    .main-content {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 25px;
    }
    
    @media (max-width: 992px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }
    
    /* Devices Grid */
    .devices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* Device Card */
    .device-card {
        background: var(--card);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .device-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }
    
    .device-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .device-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 20px;
    }
    
    .device-info h3 {
        font-size: 1.3rem;
        margin-bottom: 5px;
    }
    
    .device-id {
        color: var(--text-light);
        font-size: 0.9rem;
    }
    
    /* Status Display */
    .status-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .status-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .status-dot.on {
        background: var(--success);
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
    }
    
    .status-dot.off {
        background: var(--danger);
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
    }
    
    .status-text {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .gpio-info {
        color: var(--text-light);
        font-size: 0.9rem;
    }
    
    /* Control Buttons */
    .control-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
    }
    
    .control-btn {
        padding: 14px;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-on {
        background: var(--success);
        color: white;
    }
    
    .btn-off {
        background: var(--danger);
        color: white;
    }
    
    .btn-toggle {
        grid-column: span 2;
        background: var(--primary);
        color: white;
    }
    
    .control-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }
    
    /* Sidebar */
    .sidebar {
        background: var(--card);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar h3 {
        font-size: 1.4rem;
        margin-bottom: 20px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* Quick Actions */
    .quick-actions {
        margin-bottom: 30px;
    }
    
    .quick-btn {
        width: 100%;
        padding: 15px;
        margin-bottom: 12px;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .all-on {
        background: linear-gradient(135deg, var(--success), #059669);
        color: white;
    }
    
    .all-off {
        background: linear-gradient(135deg, var(--danger), #dc2626);
        color: white;
    }
    
    .quick-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    /* System Info */
    .system-info {
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 25px;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .info-label {
        color: var(--text-light);
    }
    
    .info-value {
        font-weight: 600;
    }
    
    /* Toast Notification */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        background: var(--success);
        color: white;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        transform: translateX(150%);
        transition: transform 0.4s ease;
        z-index: 1000;
        max-width: 350px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .toast.show {
        transform: translateX(0);
    }
    
    .toast.error {
        background: var(--danger);
    }
    
    /* Connection Status */
    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        padding: 10px 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .connection-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .connected {
        background: var(--success);
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        animation: pulse 2s infinite;
    }
    
    .disconnected {
        background: var(--danger);
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Loading Animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .header h1 { font-size: 2rem; }
        .devices-grid { grid-template-columns: 1fr; }
        .connection-status { top: 10px; right: 10px; left: 10px; }
    }
</style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <div class="connection-dot connected" id="connectionDot"></div>
        <span id="connectionText">Đang kết nối...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>
                <i class="fas fa-home"></i>
                Điều Khiển 5 Thiết Bị
            </h1>
            <p>Thao tác từng thiết bị hoặc điều khiển toàn bộ hệ thống</p>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Devices Section -->
            <div class="devices-section">
                <div class="devices-grid" id="devicesContainer">
                    <!-- Device cards will be generated here -->
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3><i class="fas fa-bolt"></i> Thao Tác Nhanh</h3>
                    <button class="quick-btn all-on" onclick="controlAll('on')">
                        <i class="fas fa-power-off"></i>
                        Bật Tất Cả
                    </button>
                    <button class="quick-btn all-off" onclick="controlAll('off')">
                        <i class="fas fa-power-off"></i>
                        Tắt Tất Cả
                    </button>
                </div>
                
                <!-- System Information -->
                <div class="system-info">
                    <h3><i class="fas fa-info-circle"></i> Thông Tin Hệ Thống</h3>
                    <div class="info-item">
                        <span class="info-label">Thiết bị đang chạy:</span>
                        <span class="info-value" id="activeDevices">0/5</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cập nhật lúc:</span>
                        <span class="info-value" id="lastUpdate">--:--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Trạng thái:</span>
                        <span class="info-value" id="systemStatus">Đang hoạt động</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Địa chỉ IP:</span>
                        <span class="info-value" id="espIp">192.168.137.99</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Thao tác thành công!</span>
    </div>

    <script>
        const ESP_IP = "http://192.168.137.99";
        let devices = [];
        let isConnected = false;
        let lastUpdateTime = null;

        // Thông tin chi tiết từng thiết bị
        const deviceDetails = [
            { 
                name: "Đèn LED 1", 
                icon: "lightbulb", 
                gpio: 23, 
                description: "Đèn chính phòng khách" 
            },
            { 
                name: "Đèn LED 2", 
                icon: "lightbulb", 
                gpio: 22, 
                description: "Đèn trang trí" 
            },
            { 
                name: "Đèn LED 3", 
                icon: "lightbulb", 
                gpio: 21, 
                description: "Đèn phòng ngủ" 
            },
            { 
                name: "Đèn LED 4", 
                icon: "lightbulb", 
                gpio: 19, 
                description: "Đèn bàn làm việc" 
            },
            { 
                name: "Đèn LED 5", 
                icon: "lightbulb", 
                gpio: 18, 
                description: "Đèn hành lang" 
            }
        ];

        // Hiển thị thông báo
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastIcon = toast.querySelector('i');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''}`;
            
            if (isError) {
                toastIcon.className = 'fas fa-exclamation-circle';
            } else {
                toastIcon.className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Cập nhật trạng thái kết nối
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                dot.className = 'connection-dot connected';
                text.textContent = 'Đã kết nối với ESP32';
            } else {
                dot.className = 'connection-dot disconnected';
                text.textContent = 'Mất kết nối với ESP32';
            }
        }

        // Tạo giao diện điều khiển từng thiết bị
        function createDeviceUI() {
            const container = document.getElementById('devicesContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const device = deviceDetails[i];
                const isOn = devices[i] === 1;
                
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                deviceCard.innerHTML = `
                    <div class="device-header">
                        <div class="device-icon">
                            <i class="fas fa-${device.icon}"></i>
                        </div>
                        <div class="device-info">
                            <h3>${device.name}</h3>
                            <div class="device-id">Thiết bị ${i} - ${device.description}</div>
                        </div>
                    </div>
                    
                    <div class="status-display">
                        <div class="status-left">
                            <div class="status-dot ${isOn ? 'on' : 'off'}"></div>
                            <div class="status-text">${isOn ? 'ĐANG BẬT' : 'ĐÃ TẮT'}</div>
                        </div>
                        <div class="gpio-info">GPIO ${device.gpio}</div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on" onclick="turnOn(${i})" id="btnOn${i}" ${isOn ? 'disabled' : ''}>
                            <i class="fas fa-power-off"></i> Bật
                        </button>
                        <button class="control-btn btn-off" onclick="turnOff(${i})" id="btnOff${i}" ${!isOn ? 'disabled' : ''}>
                            <i class="fas fa-power-off"></i> Tắt
                        </button>
                        <button class="control-btn btn-toggle" onclick="toggleDevice(${i})">
                            <i class="fas fa-sync-alt"></i> Đảo Trạng Thái
                        </button>
                    </div>
                `;
                
                container.appendChild(deviceCard);
            }
        }

        // Cập nhật trạng thái thiết bị
        function updateDeviceStatus(deviceId, isOn) {
            const btnOn = document.getElementById(`btnOn${deviceId}`);
            const btnOff = document.getElementById(`btnOff${deviceId}`);
            const statusDot = document.querySelector(`#devicesContainer .device-card:nth-child(${deviceId + 1}) .status-dot`);
            const statusText = document.querySelector(`#devicesContainer .device-card:nth-child(${deviceId + 1}) .status-text`);
            
            if (btnOn && btnOff && statusDot && statusText) {
                btnOn.disabled = isOn;
                btnOff.disabled = !isOn;
                statusDot.className = `status-dot ${isOn ? 'on' : 'off'}`;
                statusText.textContent = isOn ? 'ĐANG BẬT' : 'ĐÃ TẮT';
            }
        }

        // Cập nhật hệ thống thông tin
        function updateSystemInfo() {
            const activeCount = devices.filter(state => state === 1).length;
            document.getElementById('activeDevices').textContent = `${activeCount}/5`;
            
            if (lastUpdateTime) {
                const timeStr = lastUpdateTime.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('lastUpdate').textContent = timeStr;
            }
            
            document.getElementById('systemStatus').textContent = isConnected ? 'Đang hoạt động' : 'Mất kết nối';
            document.getElementById('espIp').textContent = ESP_IP.replace('http://', '');
        }

        // Lấy trạng thái từ ESP32
        async function getDeviceStates() {
            try {
                const response = await fetch(`${ESP_IP}/status`);
                if (!response.ok) throw new Error('Không thể kết nối');
                
                const data = await response.json();
                devices = data.device;
                lastUpdateTime = new Date();
                
                if (!isConnected) {
                    updateConnectionStatus(true);
                    showToast('Đã kết nối với ESP32');
                }
                
                createDeviceUI();
                updateSystemInfo();
                
            } catch (error) {
                console.error('Lỗi:', error);
                if (isConnected) {
                    updateConnectionStatus(false);
                    showToast('Mất kết nối với ESP32', true);
                }
            }
        }

        // Bật thiết bị cụ thể
        async function turnOn(deviceId) {
            const btn = document.getElementById(`btnOn${deviceId}`);
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div>';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${ESP_IP}/on?dev=${deviceId}`);
                if (!response.ok) throw new Error('Lỗi khi bật thiết bị');
                
                const data = await response.json();
                showToast(`Đã bật ${deviceDetails[deviceId].name}`);
                
                // Cập nhật giao diện
                devices[deviceId] = 1;
                updateDeviceStatus(deviceId, true);
                updateSystemInfo();
                
            } catch (error) {
                console.error('Lỗi:', error);
                showToast(`Lỗi khi bật thiết bị ${deviceId}`, true);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Tắt thiết bị cụ thể
        async function turnOff(deviceId) {
            const btn = document.getElementById(`btnOff${deviceId}`);
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div>';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${ESP_IP}/off?dev=${deviceId}`);
                if (!response.ok) throw new Error('Lỗi khi tắt thiết bị');
                
                const data = await response.json();
                showToast(`Đã tắt ${deviceDetails[deviceId].name}`);
                
                // Cập nhật giao diện
                devices[deviceId] = 0;
                updateDeviceStatus(deviceId, false);
                updateSystemInfo();
                
            } catch (error) {
                console.error('Lỗi:', error);
                showToast(`Lỗi khi tắt thiết bị ${deviceId}`, true);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Đảo trạng thái thiết bị
        async function toggleDevice(deviceId) {
            const currentState = devices[deviceId];
            
            if (currentState === 1) {
                await turnOff(deviceId);
            } else {
                await turnOn(deviceId);
            }
        }

        // Điều khiển tất cả thiết bị
        async function controlAll(action) {
            showToast(`Đang ${action === 'on' ? 'bật' : 'tắt'} tất cả thiết bị...`);
            
            const promises = [];
            for (let i = 0; i < 5; i++) {
                promises.push(fetch(`${ESP_IP}/${action}?dev=${i}`));
            }
            
            try {
                await Promise.all(promises);
                showToast(`Đã ${action === 'on' ? 'bật' : 'tắt'} tất cả thiết bị`);
                
                // Refresh trạng thái
                setTimeout(getDeviceStates, 500);
                
            } catch (error) {
                console.error('Lỗi:', error);
                showToast('Lỗi khi điều khiển tất cả thiết bị', true);
            }
        }

        // Khởi động hệ thống
        function init() {
            // Lấy trạng thái ban đầu
            getDeviceStates();
            
            // Cập nhật tự động mỗi 2 giây
            setInterval(getDeviceStates, 2000);
            
            // Cập nhật thời gian mỗi phút
            setInterval(updateSystemInfo, 60000);
        }

        // Bắt đầu khi trang tải xong
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>